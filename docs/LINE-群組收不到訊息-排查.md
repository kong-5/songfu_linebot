# LINE 群組收不到訊息／顯示未綁定 排查

## 1. 確認機器人已加入該群組

- 收單**只支援群組**，不支援一對一聊天。
- 請在 LINE 群組內確認：**已將本官方帳號（機器人）加入群組**。
- 若機器人不在群組內，LINE 不會把群組訊息送到你的 Webhook，後台不會收到任何事件。

## 2. 確認 Webhook 有收到事件（看 Cloud Run 日誌）

- 到 Google Cloud Console → Cloud Run → 你的服務 → **日誌**。
- 在群組傳一則訊息（例如：「取得群組ID」）。
- 若日誌出現：
  - `[LINE] 處理 events 數量: 1`、`[LINE] 群組 ID：C...` → 代表有收到，問題多半是**綁定**。
  - `[LINE] 非群組訊息 source.type= user` → 代表這則是在「與機器人一對一」聊天發的，不是群組；請改在**群組裡**傳。
  - 完全沒有 `[LINE]` 日誌 → Webhook 沒被呼叫，請檢查：
    - LINE Developers Console → 該 Channel → Messaging API → **Webhook URL** 是否正確（需可從外網連到）。
    - **Use webhook** 是否為 Enabled。

## 3. 綁定「LINE 群組 ID」（後台與群組一致）

- 在**該群組**裡傳：**取得群組ID**（或「群組ID」），機器人會回覆一串 ID（例如 `C48764d2a8908f997740d3d1408588d4a`）。
- 到後台 **客戶管理** → 點該客戶 **編輯** → 在「**LINE 群組 ID**」欄位**貼上剛才機器人回覆的那串 ID**（建議直接複製貼上，避免手打或漏字）→ **儲存**。
- 系統比對時會忽略前後空白與大小寫；儲存時也會自動去掉欄位內所有空白。若仍顯示未綁定，請確認：
  - 該客戶為**啟用**狀態（未勾選「停用」）。
  - 貼上的 ID 與群組內「取得群組ID」回覆的**完全一致**（可再傳一次「取得群組ID」比對）。

## 4. 程式已修正「比對方式」（部署後即生效）

- 若使用 **PostgreSQL（Cloud SQL）**，資料庫的 `TRIM()` 只會去掉空格，**不會去掉換行**。若先前貼上的群組 ID 含換行或不可見字元，會導致比對失敗。
- 目前改為在**應用層**比對：會先去掉雙方所有空白（含換行）再比對、且不區分大小寫，因此只要後台儲存的 ID 與 LINE 回傳的 ID 字元一致（無多打、少打），應可正確綁定。
- 請**重新部署**後再在群組傳「收單」或「取得群組ID」測試。若仍顯示未綁定，請看下一節日誌。

## 5. 若仍異常：看 Cloud Run 日誌

- 在群組傳一則訊息後，到 Cloud Run → 日誌，搜尋 `[LINE]`。
- **綁定成功**時會出現：`[LINE] 綁定查詢 OK customer=xxx`
- **綁定失敗**時會出現：`[LINE] 綁定查詢失敗 groupId 長度=33 前6=C48764 後6=8588d4a；DB 內有 line_group_id 的客戶數=1`，以及 DB 第一筆的長度與前 6、後 6 字元。請比對「LINE 的 groupId」與「DB 第一筆」的前 6、後 6 是否一致；若一致但仍查不到，請將該段日誌提供給開發者排查。
