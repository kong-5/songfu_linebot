# 用指令列設定觸發程式（主控台找不到時）

主控台若找不到「替換變數」或「設定檔路徑」，可在本機用 **終端機 + gcloud** 設定。

---

## 前置：本機已安裝 gcloud 並登入

```bash
gcloud auth login
gcloud config set project handy-implement-457807-u0
```

---

## 步驟 1：查觸發程式名稱與類型

在終端機執行：

```bash
gcloud builds triggers list --project=handy-implement-457807-u0
```

或若觸發程式在區域（例如 asia-east1）：

```bash
gcloud builds triggers list --project=handy-implement-457807-u0 --region=asia-east1
```

記下 **NAME**（觸發程式名稱）以及是 **github** 還是 **manual** 等類型。下面以觸發程式名稱為 `songfu-deploy`、類型為 **github** 為例。

---

## 步驟 2 選項 A：改用 cloudbuild-no-secrets.yaml（不設 _DATABASE_URL）

之後在 **Cloud Run 主控台** 設 DATABASE_URL 即可，觸發程式只負責建置與部署。

**若觸發程式在 global：**

```bash
gcloud builds triggers update github songfu-deploy \
  --project=handy-implement-457807-u0 \
  --build-config=cloudbuild-no-secrets.yaml
```

**若觸發程式在 asia-east1：**

```bash
gcloud builds triggers update github songfu-deploy \
  --project=handy-implement-457807-u0 \
  --region=asia-east1 \
  --build-config=cloudbuild-no-secrets.yaml
```

把 **`songfu-deploy`** 換成你步驟 1 看到的 NAME。

完成後請到 **Cloud Run** → songfu-line-bot → **編輯並部署新修訂版本** → **變數與密碼** 新增 **DATABASE_URL**，**連線** 新增 Cloud SQL 執行個體，再部署一次。

---

## 步驟 2 選項 B：在觸發程式加 _DATABASE_URL（繼續用 cloudbuild.yaml）

把下面的 **觸發程式名稱**、**連線字串** 換成你的後，整段複製到終端機執行。

**連線字串格式：**  
`postgresql://postgres:你的密碼@/songfu?host=/cloudsql/handy-implement-457807-u0:asia-east1:你的執行個體ID`

**若觸發程式在 global：**

```bash
gcloud builds triggers update github "你的觸發程式名稱" \
  --project=handy-implement-457807-u0 \
  --update-substitutions='_DATABASE_URL=postgresql://postgres:你的密碼@/songfu?host=/cloudsql/handy-implement-457807-u0:asia-east1:你的執行個體ID'
```

**若觸發程式在 asia-east1：**

```bash
gcloud builds triggers update github "你的觸發程式名稱" \
  --project=handy-implement-457807-u0 \
  --region=asia-east1 \
  --update-substitutions='_DATABASE_URL=postgresql://postgres:你的密碼@/songfu?host=/cloudsql/handy-implement-457807-u0:asia-east1:你的執行個體ID'
```

密碼若含 `@`、`#`、`%` 等，請先 [URL 編碼](https://www.urlencoder.org/) 再貼上。

---

## 若觸發程式類型不是 github

若 `gcloud builds triggers list` 顯示的類型是 **manual** 或其他，把上面指令裡的 **github** 改成對應類型，例如：

```bash
gcloud builds triggers update manual "觸發程式名稱" ...
```

不確定時可先查說明：

```bash
gcloud builds triggers update --help
```
