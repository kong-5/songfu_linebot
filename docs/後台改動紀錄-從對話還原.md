# 松富後台改動紀錄（從過往對話還原）

以下整理自過往對話中曾實作過的後台改動，供對照目前 `dist/admin/index.js` 與後續還原使用。

---

## 一、UI／版面

- **後台首頁**
  - 資料匯入（匯入客戶、匯入品項、寺岡對照）曾改為**置頂區塊**，後來改為**右側選單**，不佔主版面。
- **導覽**
  - **客戶訂單查詢**放在第一個。
  - 訂單查詢頁：可**點選日期**（並**顯示星期**）、可**搜尋**。
  - 上方「待確認品名」「單品規格表」「批次匯出」「只看有待確認的訂單」改為**按鈕**，並**顯示筆數**（例如幾筆訂單）。
- **整體樣式**
  - 新增 **`/admin/styles`** 共用樣式：背景色、卡片白底、圓角、陰影、字體（Segoe UI、Noto Sans TC）、按鈕與輸入框樣式。
- **停用／啟用**
  - 客戶列表、品項列表點「停用」或「啟用」時改為 **fetch 呼叫 API**，**不整頁重整**，只更新該列狀態與按鈕，方便連續操作。

---

## 二、QR／條碼

- **條碼 API**：`GET /admin/barcode?code=xxx`（使用 **bwip-js**，Code128，PNG）。
- **訂單明細**
  - 表格有「寺岡條碼」欄，顯示**條碼圖片**（`/admin/barcode?code=...`）。
- **訂貨單頁**：`GET /admin/orders/:orderId/order-sheet`
  - 表頭：日期、客戶。
  - 表格：凌越料號、凌越品名、叫貨數量、叫貨單位、寺岡料號、寺岡條碼（含條碼圖）。
  - **品項條碼區**：每個有寺岡條碼的品項各顯示一條碼圖 + 品名。
  - **客戶條碼**：若客戶有 `teraoka_code`（寺岡編號），顯示「客戶條碼」+ 條碼圖。
  - 列印時用 `@media print` 隱藏 `.no-print`。

---

## 三、編輯格式（訂單明細）

- **版面**
  - **左側（客戶原始，唯讀）**：客戶輸入品名、數量、單位，灰底不可改。
  - **右側（我們輸出，可改）**：凌越料號、凌越品名、叫貨數量、叫貨單位、寺岡料號、寺岡條碼。
- **要／不要 → 確認**
  - 每列有勾選「**確認**」（原為「要／不要」），預設勾選；取消勾選會彈出確認視窗。
  - 不勾選的列以**灰底灰字**呈現。
  - 資料庫：`order_items.include_export`（1＝要匯出，0＝不要）；訂貨單與批次匯出只含 `include_export=1` 的品項。
- **品項編輯**
  - 移除獨立「品項」欄；**編輯**放在**凌越品名**欄內。
  - 點「編輯」→ **彈出視窗（modal）**：客戶輸入（唯讀）、搜尋／選擇品項（模糊搜尋）、加入對照、對照範圍（全公司／此客戶專用）→ 儲存後只更新該列，不整頁重整。
  - 訂單編輯送出改為 **application/x-www-form-urlencoded**（用 URLSearchParams），避免 multipart 導致後端收不到 body。
- **待確認**
  - 訂單內「待確認」可**點擊**→ 單筆確認頁（可搜尋品項、加入對照）→ 上一頁回訂單明細。
- **我們輸出的品項**
  - 可改品項（從料號或品名），凌越料號與凌越品名隨選取品項**連動**。
  - 修正品項時可勾選「**加入對照**」，一併寫入俗名或客戶專用別名，之後叫貨會自動對應。

---

## 四、批次匯出與總表

- **入口**：訂單查詢頁、訂單明細頁的「**批次匯出**」→ `/admin/export`。
- **表單**：日期起、日期訖、**客戶多選**（含**全選／全不選**）。
- **看總表**：依條件列出訂單（日期、客戶、品項數、明細／訂貨單連結）。
- **匯出報表**：同一條件一次產出多筆訂貨單（每筆一區塊，含條碼），可列印或另存 PDF。
- **訂單表格匯出**：可匯出為 **JPG** 檔。

---

## 五、客戶

- **欄位**：寺岡編號（CustCode，QR 用）、凌越編號（HQCustCode）、LINE 群組名稱、LINE 群組 ID、叫貨備註（order_notes）、**此客戶專用別名**。
- **匯入**：cust.xls 支援 CustName、CustCode、HQCustCode、LineGroupId 等；已存在客戶可更新 LINE 群組 ID。
- **從訂單進客戶**：訂單列表／明細的客戶名稱可**點擊**→ **客戶快覽頁**（含特殊情況、專用別名）→ 有「編輯」→ 編輯後可「回訂單查詢」。
- **預設單位**：客戶可設預設單位（如「件」），未填單位時帶入該預設，否則公斤。

---

## 六、品項與俗名

- **匯入**：CommName、PluCode、HQPluCode、QtySymbol；匯入時單位為空可用「常用單位」。
- **品項列表**：搜尋、停用區、編輯／停用／啟用／刪除；俗名欄有「**俗名管理**」連結。
- **俗名**：可編輯、可刪除；**查詢俗名**（排查重複）：輸入俗名可查目前對應哪個品項。
- **品項選擇**：所有需要選品項的地方改為**可搜尋**（模糊），API：`GET /admin/api/products/search?q=關鍵字`；不再只用長下拉選單。

---

## 七、單品規格表（顆／粒／根）

- **資料表**：`product_unit_specs`（product_id, unit, note_label, conversion_kg）。
- **後台頁**：`/admin/specs`，列出曾以顆／粒／根叫貨的「品項＋單位」及手動新增的規格；可填**備註**（如「1顆」）與**推算公斤**。
- **待補提醒**：後台首頁、訂單查詢顯示「單品規格表（N 項待補）」。
- **訂單明細**：有「備註／推算」欄，顯示備註與推算公斤（數量 × conversion_kg）。
- **單品規格**的品項選擇為**可搜尋**。

---

## 八、待確認品名

- **可搜尋**：搜尋框可篩選對應品項（品名、料號模糊）。
- **訂單內待確認**可點擊 → 單筆確認頁 → 對應品項可搜尋（模糊）→ 加入對照後上一頁回訂單明細。

---

## 九、API／技術

- **條碼**：bwip-js，`/admin/barcode?code=...`。
- **品項搜尋**：`GET /admin/api/products/search?q=...`。
- **客戶／品項 toggle**：POST 時若 `Accept: application/json` 則回傳 JSON，不 redirect。
- **訂單明細編輯品項**：POST 用 urlencoded，並處理「加入對照」失敗時回傳明確訊息（如 dup 時對應品項名稱）。

---

## 還原建議

目前 `dist/admin/index.js` 為較早版本，未包含上述全部改動。還原方式建議：

1. **依此文件逐項對照**：在後台實際操作，缺哪一項就補哪一項。
2. **優先順序**：可先做 (1) 條碼 API + 訂貨單頁 (2) 訂單明細左原始／右輸出 + 確認勾選 (3) 批次匯出 (4) 右側選單與按鈕 (5) 品項搜尋 API 與各頁可搜尋 (6) 單品規格表 (7) 其餘 UI。
3. **直接改 dist**：專案目前僅有 `dist`，無 TypeScript 原始檔，故需在 **dist/admin/index.js** 內以 CommonJS 補上或修改對應路由與 HTML。

若你告訴我「先還原哪幾項」（例如：條碼＋訂貨單、或訂單明細格式），我可以依此文件在 `dist/admin/index.js` 裡幫你寫出對應的程式碼變更。

（最後更新：用於測試 GitHub 自動部署）

---

## 十、結轉時間

- **設定**：後台右側選單或獨立「設定」頁可編輯 **結轉時間**（例：17:00），存於 `app_settings`（key：`order_cutoff_time`）。
- **用途**：作為當日訂單截止時點；**LINE 叫貨**在「收單／開始收單」時會依此時間決定訂單歸屬日期（以 Asia/Taipei 為準）：若目前時間 ≥ 結轉時間，則新訂單歸到**次日**，否則歸**當日**。
- **訂單明細**：取消勾選「確認」時會彈出確認視窗（避免誤操作）。
- **訂單列表**：可點「匯出表格為 JPG」將當前篩選結果的表格匯出為 JPG 檔（使用 html2canvas）。
